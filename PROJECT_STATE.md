# PROJECT_STATE.md

## 우리가 만드는 것
- PDF나 텍스트 지문을 업로드하면 **수능 스타일 문제·해설·분석**을 자동으로 만들어 주는 학습 플랫폼.
- 학생은 웹에서 문제를 풀고 채점·해설·랭킹·신고 기능을 이용할 수 있어요.
- 선생님(관리자)은 분석본을 검수하고, 마음에 들지 않는 변형을 삭제하거나 신고를 처리할 수 있어요.

## 기술 스택 & 핵심 명령어
- **백엔드**: Node.js 20 + Express, SQLite(sql.js) / OpenAI API (fallback은 WordNet + 자체 로직)
- **프런트엔드**: React 19 (CRA), Zustand + SWR
- **공통 명령**
  - 개발: `npm run dev:all` (백엔드 5000, 프런트 3000)
  - 테스트: `npm test`
  - 프런트 빌드: `npm run build`
  - 린트: `npm run lint`

## 최근 결정/하이라이트
- Vocabulary에 단일/복수 정답을 모두 지원해요. 메타데이터에 `answerMode(correct/incorrect)`·`answerIndices`·`optionStatuses`를 기록하고, 질문 문구(올바른 것/적절하지 않은 것/모두 고르시오)도 변형을 인식합니다.
- 분석(fallback) 결과를 문장별로 라벨링해 저장합니다: "한글 해석/분석/배경지식/사례/어법 포인트/어휘 포인트"가 빠짐없이 채워지며 최소 길이를 검증해 빈 템플릿을 차단했어요.
- 학습 화면(Study) 마무리 흐름을 개선했습니다. 전부 풀지 않아도 마무리 버튼을 눌러 빠진 번호를 안내받을 수 있고, 렌더링 최적화(useMemo)로 성능을 안정화했어요.
- 어휘 하이라이트·정규식 교체에서 공백 패턴 누락 문제를 수정해 밑줄 치환이 끊기지 않도록 했어요.
- 관련 테스트와 유틸을 보강하고, 테스트용 내보내기(__testables)를 추가해 라우트 단위 검증이 쉬워졌습니다.

## 현재 단계 (2025-10-26 기준)
- Vocabulary 다중 정답/변형 + 본문 ①~⑤/밑줄 품질이 안정화되었습니다.
- 생성 파이프라인에 타임박스(25s)+자동 폴백을 도입해 타임아웃 없이 세트를 반환합니다.
- 프로덕션 도메인(league-of-english.com) + API 서브도메인 통합, CORS/리다이렉트/기본 API 주소를 정리했습니다.
- 학생 계정도 공개/관리자 문서를 기본 노출하도록 목록 정책을 확장했습니다.

## Next 3 (오늘 우선순위)
1. 관리자 UI 보완(회원 검색/정지·복구·삭제, 등급 상향/요청 승인) – 운영 효율/응대 속도↑
2. 생성 품질 2차 검증(긴 밑줄/빈약 해설/사유 부족 자동 거절→복구 루프 강화) – 콘텐츠 신뢰도↑
3. E2E 스냅샷 확대(①~⑤/밑줄/출처 라벨) + CI 아티팩트 – 회귀 방지/육안 검수 시간↓

## Known Issues
- 관리자 분석 뷰 삭제/취소 플로우 통합 테스트 보강 필요(간헐 404).
- 일부 문서에 grade/school 메타가 비어 있으면 학생 노출이 과/소노출될 수 있음(정책 튜닝 예정).
- 이메일 발송(NEVER/SMTP) 미설정 시 가입은 베타 우회로 통과(운영 전 SMTP 필수 세팅 필요).
- UI 캡처(`npm run capture:ui`) 최초 실행 시 Playwright 설치 필요.

## Resolved – 2025-10-26 (오류 반복 방지)
- 생성 타임박스(25s)+자동 폴백으로 "세트를 준비하지 못했어요" 타임아웃을 제거했습니다.
- 학생 문서 목록 정책을 확장해 공개/관리자 문서를 기본 노출(온보딩 용이)로 바꿨습니다.
- 도메인/리다이렉트/기본 API 주소/CORS를 정리해 배포 주소 혼동·404/401을 줄였습니다.
- 멤버십 상향(관리자 직접/요청 승인/쿠폰)과 사용자 정지/복구/삭제 API를 추가했습니다.
- 비밀번호 찾기(코드 메일+재설정) 엔드포인트를 추가해 계정 복구 경로를 마련했습니다.
- 문서 날짜·용어·Top3/Known Issues를 통일해 지침 불일치로 인한 시행착오를 줄였습니다.
- 관리자 삭제 404 관련 재현 케이스와 임시 회피 절차(목록 새로고침/재요청)를 문서화했습니다.
- 배포 가이드의 환경 변수 설명을 점검해 누락·혼동을 줄였습니다.
- BUILDLOG/README/PROJECT_STATE 동기화 루틴을 확립해 변경 누락을 방지했습니다.
- GitHub 비밀번호 푸시 차단으로 인한 프롬프트 정지 이슈 원인(PAT 필요)을 명확히 하고, 비대화형 푸시 절차(credential.helper/`gh`)를 README에 추가했습니다.
- 작업 비서 매뉴얼 `AGENTS.md`를 루트에 추가, 설명 톤/질문 원칙/문서 루틴/Git 규칙을 표준화했습니다.
 - 학습/어휘 제출 화면 무한 대기 문제를 타임아웃과 에러 처리로 차단했고, dev:auto로 포트 충돌을 자동 회피합니다.
 - 어휘/어법 본문에 ①~⑤ 표식을 직접 삽입하고 밑줄 두께/색을 개선, 프롬프트와 정규화로 형식 일탈을 억제했습니다.
