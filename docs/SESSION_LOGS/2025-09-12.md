# 2025-09-12 Session Log

Scope
- Fix encoding UX, enforce LOE-only upload, CSAT-normalization pass, UI polish.

Changes
- Encoding/Fonts: Added Noto Sans KR in client/public/index.html; guidance for PowerShell/CMD UTF-8.
- Upload Policy: Enforced LOE-only uploads in server/routes/document.routes.js (title must start with "LOE").
- Cleanup: Removed previously seeded non-LOE doc via scripts/db-delete-doc.js.
- Admin Tiering: Added scripts/elevate-admin.js; admin is premium, unlimited, tier=Challenger.
- UI Polish: Rewrote mojibake strings in DocumentList and ScoreHUD; added Challenger animated border (client/src/index.css), applied in ScoreHUD.
- CSAT Normalizer: Added server/utils/csatProblemNormalizer.js and integrated into get-smart-problems and generate endpoints to standardize stems, enforce 5-choice, and fill minimal explanations.
- CSAT Set: Added POST /api/generate/csat-set to produce a balanced set (order/insertion/grammar/blank/vocab/title/theme/summary).
- Scripts: Added scripts/run-with-server.js (auto smoke), scripts/seed-pdf-by-path.js, scripts/db-delete-doc.js.

Parser (from 09-11)
- Marker-first segmentation robust; short-line merge improved; unit tests added (test-marker-flex/test-merge-rules).

Next Immediate
- UI: pass over remaining mojibake strings and set global KR font usage.
- CSAT: add distractor templates + evidence-line validation; 5-choice retry on failure.
- UX: extend Challenger effects to Profile/Ranking pages.

---

Quality Gate v2 (late day)
- Validator: enforce 5-choice, ban placeholders, ban duplicates, require mainText for CSAT types (title/theme/summary/blank/implicit), require explanation length and evidenceLines (if present).
- Normalizer: unify CSAT stems; no placeholder padding; keep author-provided answers; short fallback explanation only.
- Repair pass: added distractorRepair to fix MCQs by replacing weak options from passage-derived pools; re-map correct answer.
- AI calls: retry/backoff (2 attempts), slow-call logging (>3s) with attempt count.
- Cache/Rotation: dedicated endpoints now cache AI items into DB; once a document√ótype reaches 100, serve RANDOM from DB, excluding user's recent 50 to reduce repeats; regenerate on exhaustion, then save.

Notes
- Dedicated endpoints covered: /api/generate/blank|vocab|title|topic|summary.
- Study flow currently uses get-smart-problems; next step will route it through cache-first as well or switch client to per-type endpoints.

---

Addendum (UI/Grammar Unification)
- Grammar: Removed difficulty toggle; unified to span-based 5-choice (choose incorrect). Type `grammar_span` used end-to-end.
- Insertion: Removed advanced(7-choice); fixed to 5-choice. Safer markers and spacing.
- Problem UI: All types now share the Order-style frame (Î¨∏ÏÑú Ï†úÎ™© / Î¨∏Ìï≠ / Q. / [Î≥∏Î¨∏] / [ÏÑ†ÌÉùÏßÄ]).
- Logout: Only at top-right; removed sidebar duplicate.
- Inquiries: Kept "Î¨∏ÏùòÌïòÍ∏∞"; moved "Î¨∏ÏùòÍ¥ÄÎ¶¨" into Admin (hidden in main nav).
- Login: Restored üéÆ icon and cleaned Korean labels.
- Mojibake: Fixed major broken strings across study flow (timer, nav, labels, alerts).

Addendum (Prompts/AI/Grammar ‚Äî 2nd pass)
- Prompts: Normalized all problem prompt specs to readable Korean + latest CSAT rules.
  - Files: PROBLEM_PROMPTS_TITLE/THEME/SUMMARY/VOCAB/BLANK/IRRELEVANT/IMPLICIT/GRAMMAR_SPAN.md
  - Enforced: JSON-only, 5-choice, fixed question stems, answer ‚àà [1..5], optional evidenceLines.
- AI Service: `readSpec()` now falls back to project root so updated prompts are always found.
- AI Types: Added methods for `irrelevant` and `implicit` generation (with heuristic fallback).
- Grammar: `grammarSpanGenerator` fixed span-overlap bug, randomizes error span, auto-writes explanation (rule + reason).
- Scripts: added `scripts/check-prompts.js` (lint prompts), `scripts/test-grammar-span-local.js` (quick sample), `scripts/db-check.js`.
