
# 📄 CLAUDE.md 

## 💡 프로젝트 한 줄 소개

**League of English** = “**원문 문서 → 수능형 영어 문제를 무한 생성**”하는 웹앱.
학생은 게임처럼 풀고(타이머/점수/랭크), 선생님은 문서 업로드로 바로 과제/시험 생성! 학생 점수 확인해서 공부시키기!
---

## 변경 사항 요약 (2025-09-08)

- 서버
  - 어법(고급) 생성기 안정화: `server/utils/csatGrammarGenerator.js` 정리, `<u>…</u>` 밑줄 표기 도입
  - PDF 자동 추출 복구: `pdf-parse` + `utils/newPdfParser.js` 경로로 passages JSON 저장
  - 새 문제 API 스캐폴딩(5종): `POST /api/generate/blank|vocab|title|topic|summary`
  - 스마트 캐싱: 각 타입별 동일 문서에서 100문제 이상 시 DB 랜덤 반환, 미만 시 생성 후 저장
  - OpenAI 연동 서비스: `server/services/aiProblemService.js` (키 존재 시 AI 우선, 없으면 규칙 기반)
  - 인증 스키마 마이그레이션 스크립트
    - `npm run migrate-users` → `password_hash` 채움/추가
    - `npm run migrate-users-drop-legacy` → legacy `password` 컬럼 제거(테이블 재작성)
  - 인코딩 정규화 스크립트: `npm run encoding:report` / `npm run encoding:apply-basic`

- 클라이언트(React)
  - 문법 문제 렌더러가 `<u>` 태그를 안전하게 렌더링하도록 수정: `client/src/components/study/GrammarProblemDisplay.js`

- 실행/테스트
  - 서버: `npm start` (PowerShell 실행 정책 이슈 해결)
  - 관리자: `admin / admin123`
  - PDF 업로드: `POST /api/upload-document` (title=Auto Extract 시 추출 제목 사용)

### 새 API 간단 예시

1) 로그인 → 토큰
- POST `/api/auth/login` body: `{ "username":"admin","password":"admin123" }`

2) 빈칸/어휘/제목/주제/요약 생성(공통)
- Header: `Authorization: Bearer <token>`
- Body: `{ "documentId": <숫자>, "count": 5 }`
- Endpoints:
  - `/api/generate/blank`
  - `/api/generate/vocab`
  - `/api/generate/title`
  - `/api/generate/topic`
  - `/api/generate/summary`

3) 스마트 문제(기존)
- POST `/api/get-smart-problems`
- Body 예: `{ "documentId": 44, "types": ["grammar"], "count": 2, "grammarDifficulty": "advanced" }`

### 마이그레이션/정리
- DB 정렬: `npm run migrate-users` → 이후 필요 시 `npm run migrate-users-drop-legacy`
- 인코딩 리포트/간단 치유:
  - `npm run encoding:report`
  - `npm run encoding:apply-basic` (백업 후 사용 권장)


## 🧱 기술 & 폴더 구조(최소)
## ⚙️ 설치 & 실행 (복붙만)

**테스트 계정**

* 관리자: `admin / admin123`

---

## 🔑 핵심 기능 흐름 (현재 구현 상태)

### ✅ **구현 완료** (v1.0)
1. **문서 업로드(관리자/교사)** → PDF/TXT에서 **영어만 추출** → DB 저장
2. **문제 생성(학생)** → 문서 선택 → **규칙형(순서배열/문장삽입)** + **AI형(어법)**
3. **풀이/채점/해설** → **통계/랭크** 반영 → 취약 유형 다시 연습

### 🚧 **개발 예정** (v2.0)
4. **단어장 업로드(관리자/교사)** → PDF/TXT에서 **영어만 추출** → DB 저장
5. **단어 시험생성(학생)** → 단어장 선택 → **(뜻만/동의어찾기/반의어찾기)** 
6. **문제집 분석 프로그램** → 문서 선택 → **상세분석 제공** + **이해 됐는지 확인/추가질문하기**
7. **AI 문제 확장** → **빈칸/어휘/제목/주제/요약** 유형 추가


**스마트한 포인트**

* 🧠 **중복 방지**: 최근 푼 문제 제외
* 💾 **캐싱**: 유형당 100문제 넘으면 **재사용**(비용↓), 다 풀면 다시 생성
* ⏱️ **타이머**: 기본 2분/문항, 고급 1분/문항
* 🎚️ 난이도: 기본/고급(예: 순서배열 A~~C ▶ A~~E)

---

## 🧭 문제 유형 (구현 상태별)

### ✅ **구현 완료** (3/8 유형)
* **규칙 기반(비용 0)**: 
  - ✅ **순서 배열** - 3개/5개 문장 순서 정하기
  - ✅ **문장 삽입** - 적절한 위치에 문장 삽입
* **AI 기반(OpenAI 사용)**:
  - ✅ **어법** - CSAT 수능급 어법 문제 (《밑줄》 표시)

### 🚧 **개발 예정** (5/8 유형) 
* **AI 기반**: 
  - 🔄 **빈칸** - 문맥상 적절한 어구 선택
  - 🔄 **어휘** - 밑줄 친 부분 중 틀린 어휘 찾기  
  - 🔄 **제목** - 글의 제목으로 적절한 것
  - 🔄 **주제** - 글의 주제로 적절한 것
  - 🔄 **요약** - 글 내용 요약하기

> 문두는 한국어 고정("다음 글의 ~~"), 보기 **①~⑤**, **정답+해설** 포함

---

## 🔌 API (최소 요약)


---

## 🧩 데이터(간단 개념)

* **users**: 학생/교사/관리자, 멤버십/포인트/티어
* **documents**: 업로드 텍스트(영어만), 출처/카테고리
* **problems**: 생성된 문제(유형/정답/해설/난이도)
* **study\_records**: 채점 기록(정오/시간/유저)

---

## 🎮 게이미피케이션(요약)

* **LP**(점수)로 **티어** 상승: Iron → Bronze → … → Challenger
* 정답/연속정답/첫학습 보너스, 오답/포기 페널티
티어 시스템
- Iron (0-999 LP): 기본
- Bronze (100-1999 LP): 프로필 뱃지
- Silver (2000-2999 LP): 실버 테두리
- Gold (3000-4999 LP): 골드 테두리
- Platinum (5000-9999 LP): 플레티넘 테두리, 플레티넘 이펙트
- Diamond (10000-29999 LP): 다이아몬드 테두리, 다이아몬드 이펙트
- Master (30000-99999 LP): 마스터 테두리, 마스터 이펙트
- Challenger (100000+ LP): 챌린저 특별 테두리, 챌린저 특별 이펙트

LP 시스템
획득:
- 정답: +10 LP (기본)
- 연속 정답: +15 LP
- 일일 첫 학습: +30 LP
- 주간 목표: +100 LP

차감:
- 오답: -5 LP
- 시간초과: -3 LP
- 포기: -10 LP

---

## 💰 가격(3단계 전략 · 초간단)

* **베이직 9,900원**: 월 1,000문제, 채점만
* **플러스 14,900원**: 무제한 + **해설**
* **프로 19,900원**: 플러스 + **상세 통계/추천**

> 👉 낮은 진입가 → 자연스런 업그레이드 → 수익 안정화

---

## 🧱 “AI 코딩 요청서” (매번 복붙하세요!)

> 이걸 **다음 AI에게 그대로 붙여넣기**하면, **거대한 단일파일 방지**됩니다.

* 아키텍처: **모듈러 모놀리식** (`routes/`, `services/`, `middlewares/`, `models/`, `config/`, `utils/`)
* 파일 규칙: **한 파일 500줄 초과 금지**
* 설정: 상수/규칙/매직넘버 → **`config/*.json` / `.env`** (하드코딩 금지)
* 전략패턴: 문제유형 \*\*맵(레지스트리)\*\*로 연결( **if/else 체인 금지** )
* 에러 처리: **모든 라우트 try/catch + next(err)**, 전역 에러 핸들러
* 로깅: 필수 설정 출력, **짧은 단계 로그**
* 테스트: **요청/응답 예시** 1\~2개 포함
  **체크리스트**
  \[ ] 파일 분할 OK(500줄↑ 없음) / \[ ] config/.env 사용 / \[ ] 유형 레지스트리 / \[ ] 에러 핸들러

---

## 🧰 자주 터지는 문제(빠른 해결)

* “문제 불러오기 실패”: **OPENAI\_API\_KEY** 확인, **documentId** 전달 여부, **서버 로그**
* `undefined`/상태 에러: state/핸들러 **정의** 누락 확인
* 업로드 실패: **PDF/TXT, 10MB** 제한 확인

---

## 🗺️ 로드맵 (현재 상태: 75% 완성!)

### ✅ **P1(MVP) - 완료!** 
- ✅ **로그인/인증 시스템** (admin/admin123)
- ✅ **문서 업로드** (PDF/TXT → 영어 추출)
- ✅ **기초 통계/랭킹** (LP/티어 시스템)
- ✅ **규칙형 문제 생성** (순서배열/문장삽입)
- ✅ **어법 문제** (CSAT 수능급)
- ✅ **게이미피케이션** (Iron→Challenger)
- ✅ **실시간 채점/해설**

### 🚧 **P2 - 진행중** (40% 완성)
- 🔄 **AI 문제 확장** (빈칸/어휘/제목/주제/요약)
- ❌ **단어시험 기능**
- ❌ **결제 시스템** (베이직/플러스/프로)
- ❌ **관리자 대시보드**

### 📋 **P3 - 계획** 
- **고급 통계/추천** (취약점 분석)
- **소셜 기능** (친구/경쟁)
- **모바일/PWA** 최적화
- **문제집 분석 AI**

---

## 🎨 디자인 톤(짧게)

* 다크 아카데미아 × e스포츠, 글래스모피즘 카드, 네온 액센트
* 정답 ✅ **초록 반짝임**, 오답 ❌ **빨강 흔들림**, 레벨업 이펙트 ✨

---

## 🆘 응급 복구 명령어

```bash
# DB 초기화
cd server && del database.db && node server.js

# 캐시 클리어
npm cache clean --force

# 의존성 재설치
rd /s /q node_modules && npm install
```

---

## 🎯 **현재 상태 요약** (2025.09.03 업데이트)

### **✅ 완성도: 75% (MVP 완료!)**

**🚀 지금 바로 사용 가능한 기능:**
1. **문서 업로드** → 영어 추출 → **3종류 문제 자동 생성** (순서배열/문장삽입/어법)
2. **게임처럼 학습**: 타이머/LP점수/티어시스템(Iron→Challenger)/랭킹
3. **수능급 퀄리티**: 어법문제는 실제 CSAT 형식(《밑줄》, 5지선다, 해설)

**🔗 바로 사용하기:**
- 🖥️ **서버**: http://localhost:5000  
- 🌐 **앱**: http://localhost:3001
- 🔑 **테스트 계정**: `admin / admin123`

**⚡ 다음 목표 (v2.0):**
- AI 문제 5종 추가 (빈칸/어휘/제목/주제/요약)
- 단어시험 기능
- 결제 시스템

**👨‍💻 개발자 노트:**
- 마이크로 모듈러 아키텍처 적용 ✅
- 500줄 이하 파일 분할 ✅  
- JSON 설정 활용 ✅
- 전략패턴/레지스트리 ✅
- 하드코딩 된 부분 json 파일로 바꿀 수 있으면 바꿔서 하드코딩 하지 말기.
---
